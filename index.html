<script>
    const timerDisplay = document.getElementById('timer-display');
    const minutesInput = document.getElementById('timer-minutes');
    const secondsInput = document.getElementById('timer-seconds');
    const startBtn = document.getElementById('start-btn');
    const pauseBtn = document.getElementById('pause-btn');
    const resetBtn = document.getElementById('reset-btn');
    const recentTimesList = document.getElementById('recent-times-list');

    let totalSeconds = 0;
    let timerInterval;
    let isPaused = false;
    let synth = null; // donâ€™t create synth until user gesture
    const MAX_RECENT_TIMES = 5;

    function formatTime(seconds) {
        const mins = Math.floor(seconds / 60);
        const secs = seconds % 60;
        return `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
    }

    function updateDisplay() {
        timerDisplay.textContent = formatTime(totalSeconds);
    }

    async function playSound() {
        await Tone.start(); // ensures audio context is running on mobile
        if (!synth) {
            synth = new Tone.Synth().toDestination();
        }
        synth.triggerAttackRelease("C4", "8n");
    }

    function startTimer() {
        if (totalSeconds <= 0) {
            alert("Please set a valid time!");
            return;
        }

        isPaused = false;
        startBtn.disabled = true;
        pauseBtn.disabled = false;
        resetBtn.disabled = false;
        minutesInput.disabled = true;
        secondsInput.disabled = true;

        timerInterval = setInterval(() => {
            if (totalSeconds > 0) {
                totalSeconds--;
                updateDisplay();
            } else {
                clearInterval(timerInterval);
                alert("Time's up!");
                playSound();
                resetTimerState();
            }
        }, 1000);
    }

    function pauseTimer() {
        isPaused = true;
        clearInterval(timerInterval);
        startBtn.disabled = false;
        startBtn.textContent = 'Resume';
        pauseBtn.disabled = true;
    }

    function resetTimer() {
        clearInterval(timerInterval);
        resetTimerState();
    }

    function resetTimerState() {
        totalSeconds = 0;
        minutesInput.value = 0;
        secondsInput.value = 0;
        updateDisplay();
        startBtn.disabled = false;
        pauseBtn.disabled = true;
        resetBtn.disabled = true;
        minutesInput.disabled = false;
        secondsInput.disabled = false;
        startBtn.textContent = 'Start';
    }

    function loadRecentTimes() {
        const recentTimes = JSON.parse(localStorage.getItem('recentTimers')) || [];
        recentTimesList.innerHTML = '';
        recentTimes.forEach(time => {
            const button = document.createElement('button');
            button.className = 'recent-time-btn';
            button.textContent = formatTime(time.minutes * 60 + time.seconds);
            button.addEventListener('click', () => {
                minutesInput.value = time.minutes;
                secondsInput.value = time.seconds;
            });
            recentTimesList.appendChild(button);
        });
    }

    function saveRecentTime(minutes, seconds) {
        let recentTimes = JSON.parse(localStorage.getItem('recentTimers')) || [];
        const newTime = { minutes, seconds };
        recentTimes = recentTimes.filter(time => time.minutes !== minutes || time.seconds !== seconds);
        recentTimes.unshift(newTime);
        if (recentTimes.length > MAX_RECENT_TIMES) recentTimes.pop();
        localStorage.setItem('recentTimers', JSON.stringify(recentTimes));
        loadRecentTimes();
    }

    startBtn.addEventListener('click', async () => {
        await Tone.start(); // resume context at gesture
        if (!synth) {
            synth = new Tone.Synth().toDestination();
        }
        if (!isPaused) {
            const minutes = parseInt(minutesInput.value, 10) || 0;
            const seconds = parseInt(secondsInput.value, 10) || 0;
            if (minutes > 0 || seconds > 0) {
                saveRecentTime(minutes, seconds);
            }
            totalSeconds = (minutes * 60) + seconds;
        }
        startTimer();
    });

    pauseBtn.addEventListener('click', pauseTimer);
    resetBtn.addEventListener('click', resetTimer);

    // ðŸ‘‡ ensure timer shows 00:00 immediately
    updateDisplay();
    loadRecentTimes();
</script>
